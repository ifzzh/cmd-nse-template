# Feature Specification: ACL 模块本地化

**Feature Branch**: `002-acl-localization`
**Created**: 2025-11-12
**Status**: Draft
**Input**: User description: "将涉及到ACL的部分均本地化，不要使用在线的acl模块，尽量保持对应版本对应文件的一致性，最小化修改，并中文优化，中文日志；不允许一次性本地化所有的模块，每次修改后都需要git commit并且打包镜像（更新镜像小版本号），由用户进行测试"

## Clarifications

### Session 2025-11-12

- Q: 本地化时，如何确定应该使用哪个版本的在线 ACL 模块？ → A: 使用项目依赖锁定文件（如 go.sum）中记录的精确版本哈希
- Q: 需要本地化的在线 ACL 模块来自哪个代码仓库？ → A: 从项目代码 import 语句中查看
- Q: 本地化后的 ACL 模块代码应该存放在项目的哪个目录结构中？ → A: 在 internal 目录中按照模块路径建立文件夹，具体位置由用户确定
- Q: 当待本地化的 ACL 模块依赖其他在线模块时，应该如何处理这些依赖？ → A: 仅本地化 ACL 相关模块，其他依赖保持在线引用
- Q: 容器镜像的版本号应该采用什么格式，以及小版本号如何自动递增？ → A: 使用语义化版本（如 v1.2.3），自动递增补丁版本号（第三位）
- Q: 本地化前的基线镜像版本是什么？ → A: ifzzh520/vpp-acl-firewall:v1.0.0，之后每次本地化递增补丁版本号
- Q: sdk-vpp 的 ACL 模块是否已本地化？ → A: 是，已本地化到 /home/ifzzh/Project/NSE-Frame/cmd-nse-firewall-vpp/internal/acl，无需重复本地化

### Session 2025-11-13

- Q: govpp binapi ACL 模块应该如何在 internal/ 目录中组织？ → A: 将 binapi/acl 和 binapi/acl_types 与现有的 internal/acl 并列放置，不使用 local-deps 子目录

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 单个 ACL 模块本地化 (Priority: P1)

开发团队需要将项目中依赖的 ACL 在线模块逐个迁移到本地代码库中，每次仅处理一个模块，确保该模块的功能与原在线版本完全一致,并通过中文化增强可维护性。

**Why this priority**: 这是整个本地化工作的最小可交付单元，能够独立验证本地化流程的有效性，为后续模块迁移建立标准。

**Independent Test**: 可以通过本地化单个 ACL 模块、构建镜像并在测试环境中运行功能测试来独立验证，确保该模块的所有功能正常工作且日志输出为中文。

**Acceptance Scenarios**:

1. **Given** 项目依赖某个在线 ACL 模块, **When** 开发者将该模块代码复制到本地并保持版本一致, **Then** 本地模块能够完全替代在线模块且功能无变化
2. **Given** 本地化的 ACL 模块已集成, **When** 模块运行时产生日志, **Then** 所有日志信息均以简体中文显示
3. **Given** 单个模块本地化完成, **When** 执行版本控制提交, **Then** 提交记录清晰标注了本地化的模块名称和版本号
4. **Given** 代码已提交, **When** 构建容器镜像, **Then** 镜像版本号的小版本号自动递增

---

### User Story 2 - 增量本地化与测试验证 (Priority: P2)

测试团队需要在每个模块本地化后立即进行功能验证，确保新镜像在实际环境中运行正常，避免一次性迁移多个模块导致的故障排查困难。

**Why this priority**: 增量验证能够及时发现问题并快速定位，降低回滚成本，确保系统稳定性。

**Independent Test**: 通过部署新构建的镜像到测试环境，执行该模块相关的功能测试套件，验证所有测试用例通过即可独立确认。

**Acceptance Scenarios**:

1. **Given** 新镜像已构建并推送, **When** 测试团队拉取并部署镜像, **Then** 测试环境能够成功启动且该模块功能可用
2. **Given** 模块功能测试执行中, **When** 触发模块相关操作, **Then** 日志输出为中文且内容准确反映操作状态
3. **Given** 测试验证完成, **When** 发现问题, **Then** 能够快速回滚到上一个镜像版本并定位到具体模块
4. **Given** 测试验证通过, **When** 准备下一个模块本地化, **Then** 当前模块作为稳定基线被保留

---

### User Story 3 - 版本一致性维护 (Priority: P3)

运维团队需要确保本地化后的 ACL 模块版本与原在线模块版本保持一致，避免因版本不匹配导致的兼容性问题或未预期的行为变化。

**Why this priority**: 版本一致性是长期可维护性的基础，但在单模块验证和增量测试成功后再系统性检查更为高效。

**Independent Test**: 通过对比本地模块代码与在线模块仓库的版本标签、提交哈希或发布记录，确认版本完全匹配即可独立验证。

**Acceptance Scenarios**:

1. **Given** 选定某个在线 ACL 模块进行本地化, **When** 检查该模块的版本信息, **Then** 记录准确的版本号和来源链接
2. **Given** 本地化代码已导入, **When** 对比本地代码与在线版本, **Then** 文件内容、接口签名和依赖关系完全一致
3. **Given** 版本信息已记录, **When** 未来需要升级或排查问题, **Then** 能够快速追溯到对应的在线版本和变更历史
4. **Given** 多个模块均已本地化, **When** 审查所有模块版本, **Then** 每个模块的版本信息清晰可查且无版本冲突

---

### Edge Cases

- 当在线 ACL 模块版本更新但本地版本未同步时，如何检测和通知版本不一致？
- 当 ACL 模块依赖的其他在线模块也需要本地化时，如何确定本地化的优先顺序？
- 当镜像构建失败或测试验证失败时，如何自动阻止版本号递增并回滚代码？
- 当日志中文化需要修改大量字符串时，如何确保翻译准确且不破坏日志格式？
- 当不同模块之间存在接口耦合时，如何确保本地化后的模块间通信不受影响？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须能够从项目代码 import 语句中识别所有依赖的在线 ACL 模块仓库地址，并从依赖锁定文件（go.sum）中获取其精确版本哈希
- **FR-002**: 系统必须支持每次仅本地化单个 ACL 模块，禁止批量处理，非 ACL 依赖模块保持在线引用
- **FR-003**: 本地化的 govpp binapi 模块代码必须直接存放在 internal/ 目录下与现有 acl/ 目录并列（如 internal/acl/, internal/acl_types/, internal/binapi_acl/），保持与在线版本的文件内容和结构一致，不使用 local-deps 子目录
- **FR-004**: 所有本地化模块中的日志输出必须转换为简体中文
- **FR-005**: 每次模块本地化完成后必须执行代码提交，提交信息包含模块名称和版本号
- **FR-006**: 代码提交后必须自动触发容器镜像构建，镜像名称为 ifzzh520/vpp-acl-firewall，基于基线版本 v1.0.0 自动递增补丁版本号（如 v1.0.1、v1.0.2）
- **FR-007**: 构建的新镜像必须推送到镜像仓库供测试团队拉取
- **FR-008**: 测试团队必须能够部署新镜像并执行功能验证
- **FR-009**: 测试失败时必须能够回滚到上一个稳定镜像版本
- **FR-010**: 系统必须记录每个本地化模块的原始在线版本来源和变更历史
- **FR-011**: 代码修改必须最小化，仅限于路径调整、依赖更新和日志中文化
- **FR-012**: 所有代码和文档注释必须使用简体中文
- **FR-013**: 本地化过程中必须保留原模块的接口签名和公共 API 不变

### Key Entities

- **在线 ACL 模块**: 项目当前依赖的远程 ACL 代码库中的模块，包含模块名称、版本号、仓库地址、依赖关系
- **本地化模块**: 迁移到项目本地代码库中的 ACL 模块副本，包含源代码文件、版本信息、中文化日志、修改记录
- **容器镜像**: 包含本地化模块的可部署软件包，镜像名称为 ifzzh520/vpp-acl-firewall，包含语义化版本标签（基于 v1.0.0 递增）、构建时间、关联的代码提交
- **测试报告**: 针对每个本地化模块的验证结果，包含测试状态、失败原因、日志样本、回滚记录

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 每个 ACL 模块的本地化、提交、构建、测试周期在 2 小时内完成
- **SC-002**: 本地化后的模块功能测试通过率达到 100%，无功能回归
- **SC-003**: 所有模块日志的中文化覆盖率达到 95% 以上
- **SC-004**: 镜像版本号能够自动且准确地递增，无人工干预错误
- **SC-005**: 测试失败时能够在 10 分钟内回滚到上一稳定版本
- **SC-006**: 本地化代码与在线版本的差异仅限于预定义的最小修改范围（路径、日志、依赖）
- **SC-007**: 90% 的模块本地化无需额外的依赖调整或接口修改
- **SC-008**: 每个本地化模块的版本来源可追溯性达到 100%

## Assumptions

- 假设项目已有成熟的容器镜像构建和版本管理流程
- 假设测试团队能够在新镜像发布后的 1 小时内开始验证
- 假设在线 ACL 模块的版本在本地化期间保持稳定，不会频繁更新
- 假设开发团队对 ACL 模块的功能和依赖关系有充分了解
- 假设日志中文化的翻译资源已准备或可由开发团队直接完成
- 假设每个模块的功能测试用例已存在且覆盖核心功能
- 假设镜像仓库有足够存储空间容纳频繁的版本迭代
- 假设回滚操作不会影响其他已本地化模块的稳定性
- 假设基线镜像 ifzzh520/vpp-acl-firewall:v1.0.0 已存在且可作为版本递增起点

## Dependencies

- 在线 ACL 模块仓库的访问权限和版本历史记录
- 容器镜像构建系统（如 Docker、Buildah 等）
- 镜像仓库（如 Harbor、Docker Hub 等）
- 版本控制系统（如 Git）及自动化提交钩子
- 测试环境和自动化测试框架
- 日志框架支持国际化或字符串替换机制

## Out of Scope

- 对 ACL 模块功能的增强或重构
- 一次性本地化所有模块（必须增量进行）
- 自动化在线版本更新同步机制（本阶段仅手动追踪）
- 对非 ACL 模块的本地化工作
- 性能优化或代码质量改进（保持原样）
- 跨语言或多语言日志支持（仅中文化）
