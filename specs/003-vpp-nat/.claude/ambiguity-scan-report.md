# VPP NAT 规范最终模糊性扫描报告

**扫描时间**: 2025-01-13
**扫描范围**: 渐进式清理策略对实施的影响
**已完成澄清**: Q11 (ACL 代码处理策略), Q12 (项目重命名策略)

---

## 执行摘要

经过深度分析,识别出 **3 个高优先级模糊性** 和 **2 个中优先级模糊性**,这些模糊性会影响实施决策和规划。

**关键发现**:
1. **ACL 代码删除时机和策略未明确** - 影响 P1-P4 的实施顺序和验收标准
2. **main.go 中 ACL 链的处理策略不清晰** - 影响 P1.3 的集成方式
3. **ACL 配置结构体的处理未定义** - 影响 Config 结构体修改策略

**建议**: 需要提出 Q13 进行澄清。

---

## 详细分析

### 领域 1: 实施阶段影响

#### 模糊性 1.1: ACL 代码删除的时间点和阶段划分 ⚠️ **高优先级**

**问题描述**:
Q11 回答提到"NAT 实现完成并验收合格后,彻底删除所有 ACL 相关代码",但未明确:
- "验收合格"的具体标准是什么? (P1.3 完成? P2 完成? P3 完成? P4 完成?)
- ACL 代码删除是否算作独立的阶段 (如 P5)?
- 删除操作是否在某个已有阶段(P1-P4)的末尾执行?

**影响评估**:
- **影响范围**: 实施时间线、版本管理、验收标准
- **具体影响**:
  - 如果在 P1.3 后删除 ACL: 可能导致后续阶段无法参考 ACL 实现
  - 如果在 P4 后删除 ACL: P4 是"可选"阶段,是否意味着不做 P4 就不删 ACL?
  - 如果作为独立阶段 P5: 时间线需要增加 ACL 删除的工作量估算

**当前规范中的模糊点**:
- `spec.md` Q11: "NAT 实现完成并验收合格后" - 未定义"完成"的范围
- `plan.md` Timeline Summary: P1-P4 没有提及 ACL 删除阶段
- `plan.md` Success Criteria: 未包含"ACL 代码完全删除"的验收标准

**建议澄清问题**:
- ACL 代码删除应该在哪个阶段执行? (P1.3 后? P2 后? P3 后? P4 后? 独立的 P5?)
- 删除的验收标准是什么? (编译通过? 所有 NAT 测试通过? 镜像构建成功?)
- 如果 P4 (静态端口映射) 不实施,是否仍然删除 ACL 代码?

---

#### 模糊性 1.2: ACL 和 NAT 代码共存期间的集成策略 ⚠️ **高优先级**

**问题描述**:
`main.go:224` 中 ACL 集成为 `acl.NewServer(vppConn, config.ACLConfig)`,在渐进式清理策略下:
- P1-P3 期间,NAT 代码如何与 ACL 代码共存?
  - **选项 A**: 在 server 端链中并列添加 NAT (acl.NewServer() + nat.NewServer())
  - **选项 B**: 替换 ACL 为 NAT (删除 acl.NewServer(),添加 nat.NewServer())
  - **选项 C**: 通过配置开关选择 ACL 或 NAT

**影响评估**:
- **影响范围**: P1.3 集成方式、配置管理、测试策略
- **具体影响**:
  - 选项 A: 需要确保 ACL 和 NAT 不冲突,测试需要验证两者共存
  - 选项 B: 从 P1.3 开始 ACL 功能不可用,需要确认是否可接受
  - 选项 C: 增加配置复杂度,需要 P2 提前实现配置开关

**当前规范中的模糊点**:
- `implementation-approach.md` 第 6 步提到"替换或并列 ACL",但未明确选择哪种方式
- `spec.md` Q11 未说明共存期间的处理策略
- `plan.md` P1.3 验收标准未包含 ACL 功能状态的检查

**建议澄清问题**:
- 在 P1.3 中,NAT 应该替换 ACL 还是与 ACL 并列存在?
- 如果并列存在,是否需要配置开关来选择使用 ACL 还是 NAT?
- 如果替换 ACL,是否可以接受 P1.3-P4 期间 ACL 功能不可用?

---

#### 模糊性 1.3: ACL "参考模板"的访问方式 🟡 **中优先级**

**问题描述**:
Q11 提到"ACL 代码作为参考模板存在",但未说明:
- 开发过程中如何访问 ACL 代码? (直接从 `internal/acl/` 读取? 从备份目录? 从 Git 历史?)
- 是否需要在删除前创建备份分支或标签?

**影响评估**:
- **影响范围**: 开发体验、回滚能力
- **具体影响**:
  - 如果 P1.3 替换 ACL,开发者在 P2-P4 期间如何参考 ACL 实现?
  - 如果创建备份分支,如何管理分支和版本控制?

**当前规范中的模糊点**:
- Q11 提到"可以先复制 ACL 到备份目录",但未明确备份目录路径
- 未说明是否需要创建 Git 标签 (如 `before-acl-removal`)

**建议澄清问题**:
- 是否需要在删除 ACL 代码前创建备份? (备份目录路径? Git 标签?)
- 如果不备份,如何在开发过程中参考 ACL 实现?

---

### 领域 2: 测试策略

#### 模糊性 2.1: ACL 测试用例的处理 🟢 **低优先级**

**问题描述**:
- 是否需要保留 ACL 的测试用例作为 NAT 测试的参考?
- 如果保留,测试用例应该放在哪里?

**影响评估**:
- **影响范围**: 测试覆盖率、测试复用
- **具体影响**: 如果删除 ACL 测试用例,可能丢失有价值的测试场景

**当前规范中的模糊点**:
- `spec.md` 未提及 ACL 测试用例的处理
- `plan.md` 测试交付物未包含 ACL 测试用例的迁移

**建议澄清问题**:
- 是否需要基于 ACL 测试用例创建对应的 NAT 测试用例?
- ACL 测试用例是否在 ACL 代码删除时一并删除?

**风险评估**: 低 - 可以通过编写新的 NAT 测试用例来覆盖

---

#### 模糊性 2.2: 验收标准中 ACL 功能替换的检查点 🟢 **低优先级**

**问题描述**:
- 验收标准是否需要明确"ACL 功能完全替换"的检查点?
- 如何证明 NAT 功能等价或优于 ACL 功能?

**影响评估**:
- **影响范围**: 验收标准、功能对比测试
- **具体影响**: 如果没有明确检查点,可能导致功能缺失未被发现

**当前规范中的模糊点**:
- `plan.md` Success Criteria 未包含"ACL 功能完全替换"的指标
- `spec.md` User Story 未包含"功能对比"的验收场景

**建议澄清问题**:
- 是否需要在某个阶段验证"NAT 功能覆盖了原 ACL 防火墙的所有用例"?
- 如果需要,验证方式是什么? (功能对比表? 端到端测试?)

**风险评估**: 低 - NAT 和 ACL 是不同功能,不需要严格对比

---

### 领域 3: 回滚和风险管理

#### 模糊性 3.1: ACL 代码删除后的回滚策略 🟡 **中优先级**

**问题描述**:
- 如果在 ACL 代码删除后发现 NAT 功能有严重缺陷,如何回滚到 ACL 版本?
- 回滚操作是否需要重新构建镜像?

**影响评估**:
- **影响范围**: 风险管理、生产稳定性
- **具体影响**: 如果回滚策略不明确,可能导致生产环境无法快速恢复

**当前规范中的模糊点**:
- Q11 提到"删除 ACL 代码时创建单独的 commit",但未说明回滚流程
- `plan.md` Risk Management 未包含"ACL 删除后回滚"的风险项

**建议澄清问题**:
- ACL 代码删除后,如何快速回滚到 ACL 功能? (Git revert? 重新部署旧镜像?)
- 是否需要在生产环境保留最后一个包含 ACL 的镜像版本?

**风险评估**: 中 - 可以通过 Git revert 和重新构建镜像来缓解

---

### 领域 4: 时间线调整

#### 模糊性 4.1: ACL 代码删除对时间线的影响 🟢 **低优先级**

**问题描述**:
- ACL 代码删除操作需要多少时间? (是否需要在时间线中单独估算?)
- 是否会影响 P1-P4 的时间估算?

**影响评估**:
- **影响范围**: 时间线规划
- **具体影响**: 如果删除操作复杂,可能影响总工期

**当前规范中的模糊点**:
- `plan.md` Timeline Summary 未包含 ACL 删除的时间估算

**建议澄清问题**:
- ACL 代码删除应该算作哪个阶段的一部分? (P4 末尾? 独立的 P5?)
- 删除操作预计需要多少时间? (1 小时? 4 小时?)

**风险评估**: 低 - 删除代码和更新引用通常较快 (1-2 小时)

---

### 领域 5: 文档更新

#### 模糊性 5.1: README.md 更新时机 🟢 **低优先级**

**问题描述**:
- README.md 何时从"VPP ACL 防火墙"更新为"VPP NAT 网络服务端点"?
- 是否需要在 P1.3 后立即更新,还是等到 ACL 代码删除后?

**影响评估**:
- **影响范围**: 文档一致性、用户体验
- **具体影响**: 如果文档与代码不一致,可能导致用户困惑

**当前规范中的模糊点**:
- Q12 提到"更新 README.md",但未说明更新时机
- `plan.md` Deliverables 未包含 README.md 更新的版本号

**建议澄清问题**:
- README.md 应该在哪个版本更新? (v1.0.3? v1.1.1? ACL 删除后?)
- 如果 ACL 和 NAT 共存期间,README.md 如何描述项目功能?

**风险评估**: 低 - 可以在每个版本同步更新文档

---

#### 模糊性 5.2: ACL 相关文档的处理 🟢 **低优先级**

**问题描述**:
- `specs/002-acl-localization/` 文档是否需要保留作为历史参考?
- 如果保留,是否需要添加"已废弃"标记?

**影响评估**:
- **影响范围**: 文档管理、知识保留
- **具体影响**: 如果删除历史文档,可能丢失有价值的本地化经验

**当前规范中的模糊点**:
- Q11 提到删除 ACL 代码,但未提及文档处理

**建议澄清问题**:
- ACL 本地化文档 (`specs/002-*`) 是否在 ACL 代码删除时一并删除?
- 如果保留,如何标记为"已废弃但保留作为参考"?

**风险评估**: 低 - 保留历史文档通常是最佳实践

---

### 领域 6: 依赖关系

#### 模糊性 6.1: Config 结构体中 ACLConfig 字段的处理 ⚠️ **高优先级**

**问题描述**:
代码分析显示 `internal/config.go` 中存在:
```go
type Config struct {
    ACLConfigPath string              `default:"/etc/firewall/config.yaml"`
    ACLConfig     []acl_types.ACLRule `default:""`
    ...
}

func retrieveACLRules(ctx context.Context, c *Config)
```

在删除 ACL 代码时:
- `Config.ACLConfigPath` 和 `Config.ACLConfig` 字段如何处理?
- `retrieveACLRules()` 函数如何处理?
- `internal/config.go` 中的 `acl_types` 导入如何处理?

**影响评估**:
- **影响范围**: 配置结构体、P2 配置管理、ACL 代码删除
- **具体影响**:
  - 如果直接删除字段,会破坏配置向后兼容性
  - 如果保留字段,会导致代码混乱 (引用已删除的 acl_types)
  - 如果需要迁移配置,需要在 P2 阶段实现配置格式转换

**当前规范中的模糊点**:
- `spec.md` Q11 提到"删除 `internal/acl/` 目录、main.go 中的 ACL 导入和链条、配置文件中的 ACL 规则",但未说明 Config 结构体的处理
- `plan.md` P2 阶段未提及 ACL 配置字段的迁移或删除

**建议澄清问题**:
- Config 结构体中的 ACL 字段应该何时删除? (P1.3? P2? ACL 代码删除时?)
- 是否需要在 P2 阶段实现配置格式迁移? (从 ACL 规则到 NAT 配置)
- 如果保留 ACL 字段(用于兼容),如何处理 acl_types 依赖?

---

#### 模糊性 6.2: 共享基础设施代码的依赖 🟢 **低优先级**

**问题描述**:
- ACL 代码是否与 VPP 连接、日志、配置加载等基础设施代码共享?
- 删除 ACL 代码是否会影响这些共享模块?

**影响评估**:
- **影响范围**: 代码删除风险
- **具体影响**: 如果 ACL 代码与基础设施耦合,删除可能导致编译错误

**当前规范中的模糊点**:
- 代码分析显示 ACL 代码主要在 `internal/acl/` 目录,但未确认是否有其他模块依赖

**建议澄清问题**:
- 是否需要在 ACL 代码删除前进行依赖分析? (grep "import.*acl")
- 如果发现共享代码,如何处理? (重构? 迁移到公共模块?)

**风险评估**: 低 - 代码分析显示 ACL 代码相对独立

---

## 模糊性优先级总结

### 高优先级模糊性 (必须在实施前澄清)

1. **ACL 代码删除的时间点和阶段划分** (模糊性 1.1)
   - 影响: 实施时间线、版本管理、验收标准
   - 建议: Q13 问题 1

2. **ACL 和 NAT 代码共存期间的集成策略** (模糊性 1.2)
   - 影响: P1.3 集成方式、配置管理、测试策略
   - 建议: Q13 问题 2

3. **Config 结构体中 ACLConfig 字段的处理** (模糊性 6.1)
   - 影响: 配置结构体、P2 配置管理、ACL 代码删除
   - 建议: Q13 问题 3

### 中优先级模糊性 (建议澄清,可在实施中调整)

4. **ACL "参考模板"的访问方式** (模糊性 1.3)
   - 影响: 开发体验、回滚能力
   - 建议: Q13 问题 4 (可选)

5. **ACL 代码删除后的回滚策略** (模糊性 3.1)
   - 影响: 风险管理、生产稳定性
   - 建议: Q13 问题 5 (可选)

### 低优先级模糊性 (可在实施过程中处理)

- ACL 测试用例的处理 (模糊性 2.1)
- 验收标准中 ACL 功能替换的检查点 (模糊性 2.2)
- ACL 代码删除对时间线的影响 (模糊性 4.1)
- README.md 更新时机 (模糊性 5.1)
- ACL 相关文档的处理 (模糊性 5.2)
- 共享基础设施代码的依赖 (模糊性 6.2)

---

## 建议的 Q13 澄清问题

基于以上分析,建议提出以下 Q13 问题:

### Q13: 渐进式清理策略的实施细节

#### 核心问题 1: ACL 代码删除的时间点和阶段划分 ⚠️ **必须澄清**

**问题**:
- ACL 代码应该在哪个阶段删除?
  - 选项 A: P1.3 (基础 NAT 功能完成) 后立即删除
  - 选项 B: P2 (配置管理) 后删除
  - 选项 C: P3 (模块本地化) 后删除
  - 选项 D: P4 (静态端口映射) 后删除
  - 选项 E: 作为独立的阶段 P5

- ACL 代码删除的验收标准是什么?
  - 编译通过?
  - 所有 NAT 测试通过?
  - Docker 镜像构建成功?
  - K8s 部署测试通过?

- 如果 P4 (静态端口映射) 不实施,是否仍然删除 ACL 代码?

#### 核心问题 2: ACL 和 NAT 代码共存期间的集成策略 ⚠️ **必须澄清**

**问题**:
- 在 P1.3 中,NAT 应该如何与 ACL 集成?
  - 选项 A: 并列添加 (acl.NewServer() + nat.NewServer() 同时存在)
  - 选项 B: 替换 ACL (删除 acl.NewServer(),添加 nat.NewServer())
  - 选项 C: 通过配置开关选择 ACL 或 NAT

- 如果选择选项 A (并列),是否需要验证 ACL 和 NAT 共存无冲突?
- 如果选择选项 B (替换),是否可以接受 P1.3-P4 期间 ACL 功能不可用?
- 如果选择选项 C (配置开关),配置开关应该在哪个阶段实现? (P1.3? P2?)

#### 核心问题 3: Config 结构体中 ACLConfig 字段的处理 ⚠️ **必须澄清**

**问题**:
`internal/config.go` 中存在以下 ACL 相关字段:
```go
type Config struct {
    ACLConfigPath string              `default:"/etc/firewall/config.yaml"`
    ACLConfig     []acl_types.ACLRule `default:""`
    ...
}
```

- 这些字段应该何时删除或修改?
  - 选项 A: P1.3 中立即删除
  - 选项 B: P2 中迁移为 NAT 配置字段
  - 选项 C: ACL 代码删除时一并删除
  - 选项 D: 保留但标记为废弃 (用于配置兼容)

- 如果选择选项 B (迁移),NAT 配置字段的结构是什么?
  ```go
  type Config struct {
      NATConfigPath string      `default:"/etc/nat/config.yaml"`
      NATConfig     NATConfig   // 待定义
      ...
  }
  ```

- `retrieveACLRules()` 函数应该如何处理?
  - 重命名为 `retrieveNATConfig()`?
  - 删除并在 P2 中重新实现?

#### 可选问题 4: ACL "参考模板"的访问方式 🟡 **建议澄清**

**问题**:
- 是否需要在删除 ACL 代码前创建备份?
  - 选项 A: 创建备份目录 (如 `.archive/acl/`)
  - 选项 B: 创建 Git 标签 (如 `before-acl-removal`)
  - 选项 C: 不备份,直接从 Git 历史访问

- 如果选择选项 A (备份目录),目录路径是什么?
- 如果选择选项 B (Git 标签),标签命名规范是什么?

#### 可选问题 5: ACL 代码删除后的回滚策略 🟡 **建议澄清**

**问题**:
- 如果在 ACL 代码删除后发现 NAT 功能有严重缺陷,回滚流程是什么?
  - 选项 A: Git revert 删除 ACL 的 commit,重新构建镜像
  - 选项 B: 重新部署最后一个包含 ACL 的镜像版本
  - 选项 C: 从 Git 标签恢复 ACL 代码

- 是否需要在生产环境保留最后一个包含 ACL 的镜像版本?

---

## 结论

### 关键模糊性识别

经过深度扫描,识别出 **3 个高优先级模糊性**,这些模糊性会直接影响实施决策和规划:

1. ACL 代码删除的时间点和阶段划分
2. ACL 和 NAT 代码共存期间的集成策略
3. Config 结构体中 ACLConfig 字段的处理

### 建议

**强烈建议提出 Q13 进行澄清**,包含:
- 3 个核心问题 (必须澄清)
- 2 个可选问题 (建议澄清)

澄清这些问题后,实施计划将更加明确,风险更可控。

### 风险评估

如果不澄清这些模糊性:
- **高风险**: 可能导致 P1.3-P4 实施策略不一致,需要中途重构
- **中风险**: 可能导致配置管理复杂化,回滚困难
- **低风险**: 文档和测试策略可以在实施过程中调整

### 下一步行动

1. 将此报告提交给用户审核
2. 根据用户反馈,决定是否提出 Q13
3. 如果提出 Q13,等待用户回答后更新 `spec.md` 和 `plan.md`
4. 如果不提出 Q13,在实施过程中根据"最小化改动"原则做出默认选择

---

**报告生成时间**: 2025-01-13
**报告状态**: 待用户审核
**建议操作**: 提出 Q13 澄清高优先级模糊性
