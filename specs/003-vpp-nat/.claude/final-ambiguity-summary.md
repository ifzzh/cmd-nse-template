# VPP NAT 规范最终模糊性扫描 - 执行摘要

**扫描完成时间**: 2025-01-13  
**扫描触发**: 用户完成 Q11 (渐进式清理策略) 和 Q12 (项目重命名策略) 的澄清  
**扫描范围**: 渐进式清理策略对 P1-P4 实施阶段的影响

---

## 核心发现

经过深度代码分析和规范审查,识别出 **3 个高优先级关键模糊性**,这些模糊性会直接影响实施决策和规划:

### 1. ACL 代码删除的时间点和阶段划分 ⚠️ **必须澄清**

**问题**: Q11 说"NAT 实现完成并验收合格后删除 ACL 代码",但未明确:
- "验收合格"是指 P1.3? P2? P3? 还是 P4 完成?
- ACL 删除是否算作独立阶段 (P5)?
- 如果 P4 (静态端口映射) 不实施,是否仍删除 ACL?

**影响**: 实施时间线、版本管理、验收标准

---

### 2. ACL 和 NAT 代码共存期间的集成策略 ⚠️ **必须澄清**

**问题**: `main.go:224` 集成 ACL 为 `acl.NewServer()`,在 P1.3 中 NAT 应该:
- **选项 A**: 并列添加 (acl.NewServer() + nat.NewServer())
- **选项 B**: 替换 ACL (删除 acl.NewServer(),添加 nat.NewServer())
- **选项 C**: 通过配置开关选择 ACL 或 NAT

**影响**: P1.3 集成方式、配置管理、测试策略

---

### 3. Config 结构体中 ACLConfig 字段的处理 ⚠️ **必须澄清**

**问题**: `internal/config.go` 包含:
```go
type Config struct {
    ACLConfigPath string              `default:"/etc/firewall/config.yaml"`
    ACLConfig     []acl_types.ACLRule // 依赖 acl_types
    ...
}
```

这些字段应该:
- **选项 A**: P1.3 中立即删除
- **选项 B**: P2 中迁移为 NAT 配置字段
- **选项 C**: ACL 代码删除时一并删除
- **选项 D**: 保留但标记为废弃

**影响**: 配置结构体设计、P2 配置管理、ACL 代码删除

---

## 中优先级模糊性 (建议澄清)

4. **ACL "参考模板"的访问方式**: 是否需要备份目录或 Git 标签?
5. **ACL 代码删除后的回滚策略**: 如何快速回滚到 ACL 版本?

## 低优先级模糊性 (可在实施中处理)

- ACL 测试用例的处理
- 验收标准中 ACL 功能替换的检查点
- ACL 代码删除对时间线的影响 (时间估算)
- README.md 更新时机
- ACL 相关文档的处理
- 共享基础设施代码的依赖

---

## 建议行动

### 强烈建议: 提出 Q13 澄清问题

包含以下 **3 个核心问题** (必须澄清):

**Q13.1**: ACL 代码删除的时间点和阶段划分
- ACL 代码应该在哪个阶段删除? (P1.3/P2/P3/P4/独立P5)
- 删除的验收标准是什么?
- 如果 P4 不实施,是否仍删除 ACL?

**Q13.2**: ACL 和 NAT 代码共存期间的集成策略
- NAT 应该并列、替换还是配置开关选择 ACL?
- 如果替换,是否可接受 P1.3-P4 期间 ACL 功能不可用?

**Q13.3**: Config 结构体中 ACLConfig 字段的处理
- ACL 字段何时删除或迁移? (P1.3/P2/ACL删除时)
- 如果 P2 迁移,NAT 配置字段结构是什么?

**可选问题** (建议澄清,但可在实施中调整):
- Q13.4: ACL "参考模板"的访问方式 (备份策略)
- Q13.5: ACL 代码删除后的回滚策略

---

## 风险评估

### 如果不澄清这些模糊性:

- **高风险**: 可能导致 P1.3-P4 实施策略不一致,需要中途重构
  - 例如: P1.3 替换 ACL,但 P2-P4 发现需要参考 ACL 实现,导致返工
- **中风险**: 可能导致配置管理复杂化,回滚困难
  - 例如: Config 结构体设计不当,需要在多个阶段反复修改
- **低风险**: 文档和测试策略可以在实施过程中调整

### 如果澄清这些模糊性:

- 实施计划更加明确,开发者可以直接按计划执行
- 版本控制和回滚策略清晰,降低风险
- 配置管理和代码集成策略一致,减少返工

---

## 详细分析报告

完整的模糊性分析报告 (包含 12 个模糊性的详细描述、影响评估、建议澄清问题) 请参考:

**报告路径**: `/home/ifzzh/Project/NSE-Frame/cmd-nse-firewall-vpp/specs/003-vpp-nat/.claude/ambiguity-scan-report.md`

---

## 下一步行动建议

1. **用户审核此摘要**: 确认是否需要提出 Q13
2. **决策点**:
   - **选项 A** (推荐): 提出 Q13,等待回答后更新 `spec.md` 和 `plan.md`
   - **选项 B**: 不提出 Q13,在实施过程中根据"最小化改动"原则做出默认选择
3. **如果选择选项 A**: 我将基于用户回答更新规范,并确认可以开始实施
4. **如果选择选项 B**: 我将为高优先级模糊性提供默认建议 (基于现有代码结构和最佳实践)

---

**报告状态**: ✅ 扫描完成,待用户决策  
**建议操作**: 提出 Q13 澄清 3 个高优先级模糊性
